<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>My experiment</title>
    <script src="https://unpkg.com/jspsych@7.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
    <link href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <script>
        // jsPsychの初期化
        const jsPsych = initJsPsych({
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });
        
        // 背景色の変更
        function set_html_style_instruction(){
          document.body.style.backgroundColor = '#FFFFFF'
        }

        function set_html_style_trial(){
          document.body.style.backgroundColor = '#000000'
        }

        // 奇数/偶数判定の刺激
        const stimuli_oe = [
            {stimulus: "<p style = 'color:white; font-size:50pt;'>1</p>",
            data: {correct_key: 's'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>2</p>",
            data: {correct_key: 'a'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>3</p>",
            data: {correct_key: 's'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>4</p>",
            data: {correct_key: 'a'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>5</p>",
            data: {correct_key: 's'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>6</p>",
            data: {correct_key: 'a'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>7</p>",
            data: {correct_key: 's'}},  
            {stimulus: "<p style = 'color:white; font-size:50pt;'>8</p>",
            data: {correct_key: 'a'}},
            {stimulus: "<p style = 'color:white; font-size:50pt;'>9</p>",
            data: {correct_key: 's'}}                                                                              
        ];        
        // timelineの設定
        const timeline = []

        // 注視点の呈示
        const instruction = {
          on_start: set_html_style_instruction,
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '奇数はs, 偶数はa　次に行くにはスペースをおせ',
          choices: [' ']
        };
        timeline.push(instruction);

        // 注視点の呈示
        const fixation = {
          on_start: set_html_style_trial,
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '+',
          trial_duration: 500
        };
        timeline.push(fixation);

        // テキストの呈示
        const trial_oe = {
          timeline:[{
              on_start: set_html_style_trial,
              type: jsPsychHtmlKeyboardResponse,
              stimulus: jsPsych.timelineVariable('stimulus'),
              choices: ['s','a'],
              data: jsPsych.timelineVariable('data'),
                on_finish: function(data){
                    // correctは反応の結果によって書き変わるものなので、const(ant)ではなく、letで宣言しなくてはいけません。
                    let correct = 0;
                    console.log(data.correct_key)
                    console.log(data.response)
                    if(data.correct_key == data.response){
                        // ここでconst をつけると思っているような動作になりません。
                        // constをつけていると、if文の中だけの定数として扱われます。if文を抜けたときに、correctが破棄されるようなイメージとなります。
                        correct = 1;
                    }
                    console.log(correct)
                    data.correct = correct;   
                },              
            }],
            timeline_variables: stimuli_oe,
            };
            timeline.push(trial_oe);

        // 
        function getCorrectness(){
            const lasttrialdata = jsPsych.data.getLastTrialData();
            console.log(lasttrialdata);
            console.log(lasttrialdata.correct) // undefinedとなって、きちんと参照できないことが分かります。
            console.log(jsPsych.data.get().last(1)) // 余談ですが、これで lasttrialdata と同じになります。
            console.log(lasttrialdata.values()); // 実は values() を使わなくてはいけません。https://www.jspsych.org/7.3/reference/jspsych-data/#values
            if (lasttrialdata.values()[0].correct == 1) { // すごく分かりにくいのですが、このようにしなくてはいけません
                return '正しい回答です。';
            } else {
                return '誤った回答です。';
            };
        };       
        
      // デブリーフィング
        const deblief = {
          on_start: set_html_style_instruction,
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '作業完了コードは0334 スペースおせ',
          choices: [' ']
        };
        timeline.push(deblief);

        /*タイムラインの実行*/
        jsPsych.run(timeline);

    </script>
  </body>
</html>